# Windows Credentials

## Windows Password Hashes

Windows uses authentication protocols to enable clients and servers to communicate with each other. Kerberos is widely used, but NT Lan Manager (NTLM) is still used. It is used, for example, when a client uses an IP address to authenticate to a server, or a client wants to authenticate to a server which is not a part of the same domain.

Windows uses different forms of NTLM hashes to secure user credentials. When an account is created, the credentials are hashed using the MD4 hashing algorithm.

The credentials are stored in a database file which is known as the Security Account Manager (SAM). This file is encrypted with a syskey. It is also locked by the NT kernel whilst the operating system is running. It cannot be copied whilst the os is running.

Authentication and verification of users credentials is undertaken by the *Local Security Authority*. This uses the LSASS process which interacts with the SAM. Since the LSASS process interacts with the SAM, we can find the SAM hashes in the memory of the LSASS process. In order to do this, elevated privileges are needed. Tools such as mimikatz use the LSASS memory to try to retrieve and dump the hashes from the SAM.

NTLM uses three messages to establish authentication. The first message is a negotiation, the second is a challenge and the third is authentication. The first message is the username sent as plaintext. The second message is a challenge which has been generated by the server. The client then hashes the challenge using the hash of the user password and returns this hashed challenge to the server.

## Windows Configuration Files

Applications on Windows machines sometimes store credentials which can be used by attackers for privilege escalation. These credentials are sometimes stored as clear text. We can perform a simple search via powershell using: `findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml`

Sensitive IIS information such as credentials may be stored in a web.config file. For the default IIS website, this could be located at `C:\inetpub\wwwroot\web.config` but there may be multiple versions of this file in different locations, which we can search for recursively.

### Unattended Installation Files

Windows can automate repetitive tasks such as the mass installation of Windows onto machines. The tool which is used to do this is the Unattended Windows Setup utility. This utility can contain user credentials including the Administrator account password. System administrators need to manually remove the configuration file from each system once Windows has been installed. If this has not been done, an attacker might be able to find the file and loot credentials from it.

The Unattended Windows Setup utility will tend to utilise one of two configuration files which contain user credentials: `C:\Windows\Panther\Unattend.xml` or `C:\Windows\Panther\Autounattend.xml` These configuration files may well be under a sub directory call `Unattend`. We can search for it by navigating to `C:\` and then using: `dir /s *Unattend.xml*`

If we find the .xml file we can look inside it and try to find the `<AutoLogon>` configuration. We will hopefully find the Administrator username along with its password.

It may well be that the password has been encoded using base64 so we will probably need to decode it before we can try using it with other attacks against Windows such as psexec. If the `<PlainText>` attribute is set to false then we know the password value is base64 encoded. We can decode it on a linux machine by copying the encoded value into a .txt file and then using: `sudo base64 -d password.txt`

## Mimikatz

Mimikatz is a tool which requires admin privileges to work properly. It allows us to dump cleartext passwords, hashes and kerberos tickets from the lsass.exe process memory.

The lsass.exe process manages user authentication on windows systems. In order to do this, it needs to interact with the SAM database. This means it will keep data from the SAM database cached in its memory in ram - mimikatz seeks to exploit this.

We can use a meterpreter session to load the kiwi module to use mimikatz: `load kiwi` If we do this, we will not need to upload a mimikatz binary to the victim machine and everything can happen in memory. An alternative is to transfer a copy of the mimikatz binary to a victim machine and then try to execute it. Another alternative is to attempt to get an empire session on the victim machine and use the mimikatz modules from within that.

### Kiwi Extension

If we have a meterpreter session, we can use: `load kiwi` to load an extension which gives us mimikatz. We can then run commands such as `lsa_dump_sam` This command dumps all the NTLM hashes it finds in the lsass.exe memory cache. It will also give us the syskey which is used to encrypt the sam database file. We can also use `creds_all` to look for other credentials such as plaintext passwords from wdigest though this will probably not return anything as newer versions of windows do not store any cleartext passwords. We can look for cleartext credentials in the lsa secrets by using: `lsa_dump_secrets`

### Mimikatz Executable

If we are working with kali linux, we can find a copy of the mimikatz executable file at: `/usr/share/windows-resources/mimikatz/x64/mimikatz.exe`

Once we have transfered it to a compromised windows machine, we can run it using `.\mimikatz.exe` The first command we need to run is `privilege::debug` If we see `'20' OK` then we have the necessary privileges to extract hashes from the lsass.exe process memory.

We can use `lsadump::sam` to get hashes and other data from the lsass.exe process memory cache from the sam database. We can try to retrieve the lsa secrets using `lsadump::secrets`

We can try to retrieve cleartext passwords using `sekurlsa::logonpasswords` We will get a result if the victim system has been configured to store cleartext passwords for successful logins.

---

> a very little key will open a very heavy door